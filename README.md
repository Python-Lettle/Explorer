
# EcoExplore: Multiplayer ğŸŒ²

è¿™æ˜¯ä¸€ä¸ªå¤šäººåœ¨çº¿åä½œæ¢ç´¢ä¸å®¶å›­å»ºè®¾æ¸¸æˆçš„ Web å‰ç«¯é¡¹ç›®ã€‚

æœ¬é¡¹ç›®æ”¯æŒ **Mock æ¨¡å¼**ï¼ˆçº¯å‰ç«¯æ¼”ç¤ºï¼‰å’Œ **çœŸå®åç«¯æ¨¡å¼**ã€‚

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. è¿è¡Œé¡¹ç›®

ç”±äºæœ¬é¡¹ç›®ä½¿ç”¨äº† ES Modules (`import/export`)ï¼Œæµè§ˆå™¨**ä¸å…è®¸**ç›´æ¥é€šè¿‡ `file://` åè®®ï¼ˆå³åŒå‡» HTML æ–‡ä»¶ï¼‰æ‰“å¼€ã€‚

**å¿…é¡»ä½¿ç”¨æœ¬åœ° HTTP æœåŠ¡å™¨è¿è¡Œã€‚**

æ¨èæ–¹å¼ï¼š
*   **VS Code**: å®‰è£… "Live Server" æ’ä»¶ï¼Œå³é”® `index.html` é€‰æ‹© "Open with Live Server"ã€‚
*   **Python**: åœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œ `python -m http.server`ï¼Œç„¶åè®¿é—® `http://localhost:8000`ã€‚
*   **Node.js**: è¿è¡Œ `npx serve .`ã€‚

### 2. å¸¸è§é—®é¢˜ (Troubleshooting)

#### âš ï¸ æ§åˆ¶å°è­¦å‘Š: `cdn.tailwindcss.com should not be used in production`
**è¿™æ˜¯æ­£å¸¸çš„ã€‚**
ä¸ºäº†ç®€åŒ–é¡¹ç›®ç»“æ„ï¼ˆæ— éœ€ npm install å’Œæ„å»ºæ­¥éª¤ï¼‰ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† Tailwind CSS çš„ CDN ç‰ˆæœ¬ã€‚å®ƒä¼šåœ¨æ§åˆ¶å°æ‰“å°æ­¤è­¦å‘Šï¼Œæç¤ºä½ åœ¨æ­£å¼ä¸Šçº¿äº§å“æ—¶åº”è¯¥ä½¿ç”¨ PostCSS æ„å»ºæµç¨‹ã€‚åœ¨å¼€å‘å’ŒåŸå‹æ¼”ç¤ºé˜¶æ®µï¼Œè¯·å¿½ç•¥æ­¤è­¦å‘Šã€‚

#### âš ï¸ å±å¹•ç©ºç™½ / æ¨¡å—åŠ è½½å¤±è´¥
è¯·ç¡®ä¿ä½ ä½¿ç”¨äº†æœ¬åœ°æœåŠ¡å™¨ï¼ˆå¦‚ä¸Šæ‰€è¿°ï¼‰ã€‚å¦‚æœåœ¨æ§åˆ¶å°çœ‹åˆ° `CORS` é”™è¯¯ï¼Œè¯´æ˜ä½ æ˜¯ç›´æ¥æ‰“å¼€äº†æ–‡ä»¶ï¼Œè¯·æ”¹ä¸ºä½¿ç”¨ HTTP æœåŠ¡å™¨ã€‚

---

## ğŸ— æ¶æ„ä¸åç«¯å¯¹æ¥æŒ‡å—

ä¸ºäº†å¯ç”¨çœŸå®çš„å¤šäººè”æœºåŠŸèƒ½ï¼Œéœ€è¦å¼€å‘ä¸€ä¸ªåç«¯æœåŠ¡ã€‚ä»¥ä¸‹æ˜¯å‰ç«¯ `RealServer.ts` æœŸæœ›çš„é€šä¿¡åè®®å’Œæ¥å£è§„èŒƒã€‚

### 1. é€šä¿¡åè®®

*   **åè®®**: WebSocket
*   **é»˜è®¤åœ°å€**: `ws://localhost:8080/ws` (å¯åœ¨ `constants.ts` ä¸­ä¿®æ”¹ `BACKEND_URL`)
*   **æ•°æ®æ ¼å¼**: JSON

### 2. å®¢æˆ·ç«¯ -> æœåŠ¡ç«¯ (Client Events)

å‰ç«¯é€šè¿‡ WebSocket å‘é€å¦‚ä¸‹ JSON æ¶ˆæ¯ã€‚åç«¯éœ€è¦ç›‘å¬è¿™äº› `type` å¹¶å¤„ç†ç›¸åº”çš„æ¸¸æˆé€»è¾‘ã€‚

| æ¶ˆæ¯ç±»å‹ (type) | è½½è·å‚æ•° (payload) | æè¿° | åç«¯é€»è¾‘å»ºè®® |
| :--- | :--- | :--- | :--- |
| `LOGIN` | `{}` | ç©å®¶è¿æ¥åˆå§‹åŒ– | åˆ›å»ºç©å®¶ Sessionï¼Œåˆå§‹åŒ–ç©å®¶æ•°æ®ï¼Œè¿”å›åˆå§‹ `STATE_UPDATE`ã€‚ |
| `ENTER_WORLD` | `{}` | åˆ‡æ¢åˆ°ä¸–ç•Œæ¢ç´¢æ¨¡å¼ | å°† `mode` è®¾ä¸º `WORLD`ï¼Œå°†ç©å®¶åŠ å…¥ç©ºé—´ç´¢å¼•/ç‰©ç†ä¸–ç•Œã€‚ |
| `RETURN_HOME` | `{}` | åˆ‡æ¢å›å®¶å›­æ¨¡å¼ | å°† `mode` è®¾ä¸º `HOME`ï¼Œä»ç‰©ç†ä¸–ç•Œç§»é™¤ç©å®¶å®ä½“ï¼ˆå¯é€‰ï¼‰ã€‚ |
| `MOVE` | `delta: {x: number, y: number}` | ç©å®¶ç§»åŠ¨è¯·æ±‚ | éªŒè¯ç§»åŠ¨åˆæ³•æ€§ï¼ˆç¢°æ’æ£€æµ‹ï¼‰ï¼Œæ›´æ–°ç©å®¶åæ ‡ã€‚`delta` ä¸ºå½’ä¸€åŒ–å‘é‡æˆ–ä½ç§»é‡ã€‚ |
| `ATTACK` | `targetId: string` | æ”»å‡»ç›®æ ‡ | æ£€æŸ¥è·ç¦»ï¼Œè®¡ç®—ä¼¤å®³ï¼Œæ‰£é™¤ç›®æ ‡ HPã€‚å¦‚æœç›®æ ‡æ­»äº¡ï¼Œç”Ÿæˆæ‰è½ç‰©ã€‚ |
| `LOOT` | `entityId: string` | æ‹¾å–æ‰è½ç‰© | æ£€æŸ¥è·ç¦»ï¼Œå°†æ‰è½ç‰©è½¬åŒ–ä¸ºç‰©å“åŠ å…¥ç©å®¶èƒŒåŒ…ï¼Œç§»é™¤æ‰è½ç‰©å®ä½“ã€‚ |
| `CHAT` | `text: string` | å‘é€èŠå¤©æ¶ˆæ¯ | å¹¿æ’­æ¶ˆæ¯ç»™åŒåœ°å›¾/åŒåŒºåŸŸçš„å…¶ä»–ç©å®¶ã€‚ |
| `OPEN_CONTAINER` | `itemId: string` | å¼€å¯èƒŒåŒ…ä¸­çš„ç®±å­ | æ¶ˆè€—ç®±å­ç‰©å“ï¼Œéšæœºç”Ÿæˆèµ„æºå¥–åŠ±ç»™ç©å®¶ã€‚ |
| `PLANT` | `buildingId: string` | åœ¨å†œç”°ç§æ¤ | æ ¡éªŒç§å­æ•°é‡ï¼Œè®¾ç½®è¯¥å»ºç­‘ `cropType` å’Œ `plantTime`ã€‚ |
| `HARVEST` | `buildingId: string` | æ”¶è·å†œä½œç‰© | æ ¡éªŒæˆç†ŸçŠ¶æ€ï¼Œé‡ç½®å»ºç­‘çŠ¶æ€ï¼Œå¢åŠ ä½œç‰©èµ„æºï¼Œå¢åŠ ç»éªŒã€‚ |
| `RECOVER_HP` | `buildingId: string` | åœ¨é£Ÿå ‚è¿›é£Ÿ | æ¶ˆè€—ä½œç‰©èµ„æºï¼Œæ¢å¤ç©å®¶ HPã€‚ |

#### æ¶ˆæ¯ç¤ºä¾‹

**ç§»åŠ¨è¯·æ±‚:**
```json
{
  "type": "MOVE",
  "delta": { "x": 1.0, "y": 0.0 }
}
```

**æ”»å‡»è¯·æ±‚:**
```json
{
  "type": "ATTACK",
  "targetId": "entity-uuid-1234"
}
```

---

### 3. æœåŠ¡ç«¯ -> å®¢æˆ·ç«¯ (Server Events)

ç›®å‰å‰ç«¯æ¶æ„è¾ƒä¸ºç®€å•ï¼ŒæœŸæœ›åç«¯åœ¨ä»»ä½•çŠ¶æ€å˜æ›´æ—¶ï¼ˆæˆ–ä»¥å›ºå®šé¢‘ç‡ï¼Œå¦‚ 20Hzï¼‰æ¨é€**å®Œæ•´çš„æ¸¸æˆçŠ¶æ€**ã€‚

#### æ¶ˆæ¯ç»“æ„

```json
{
  "type": "STATE_UPDATE",
  "payload": { ...GameState Object... }
}
```

#### Payload (GameState) æ•°æ®ç»“æ„è¯¦æƒ…

åç«¯è¿”å›çš„ JSON å¿…é¡»ç¬¦åˆä»¥ä¸‹ Typescript æ¥å£å®šä¹‰ï¼š

```typescript
interface GameState {
  // å½“å‰æ¸¸æˆæ¨¡å¼
  mode: 'LOBBY' | 'WORLD' | 'HOME';
  
  // æ¶ˆæ¯æ—¥å¿— (èŠå¤©/ç³»ç»Ÿæç¤º)
  messages: string[];
  
  // åœ°å›¾ä¸Šçš„å®ä½“ (ç©å®¶, æ€ªç‰©, æ‰è½ç‰©)
  entities: {
    id: string;
    type: 'PLAYER' | 'OTHER_PLAYER' | 'MONSTER_SLIME' | 'MONSTER_BEAST' | 'LOOT_CONTAINER';
    pos: { x: number, y: number };
    hp: number;
    maxHp: number;
    name: string;
  }[];
  
  // é™æ€è£…é¥°ç‰© (æ ‘, çŸ³å¤´, å¢™å£ - ä»… WORLD æ¨¡å¼éœ€è¦å‘é€ï¼Œæˆ–è€…å‰ç«¯ç¡¬ç¼–ç )
  decorations: {
    id: string;
    type: 'TREE' | 'ROCK' | 'WATER' | 'WALL';
    pos: { x: number, y: number };
    scale: number;
  }[];

  // å½“å‰ç©å®¶çš„è¯¦ç»†çŠ¶æ€
  player: {
    id: string;
    name: string;
    pos: { x: number, y: number };
    hp: number;
    maxHp: number;
    inventory: { id: string, type: string, count: number }[];
    maxInventory: number;
    level: number;
    exp: number;
  };

  // å®¶å›­æ•°æ®
  home: {
    buildings: {
      id: string;
      type: 'FIELD' | 'WORKBENCH' | 'CONTAINER_OPENER' | 'CANTEEN';
      pos: { x: number, y: number };
      level: number;
      cropType?: string; // ä»… FIELD æœ‰æ•ˆ
      isReady?: boolean; // ä»… FIELD æœ‰æ•ˆ
    }[];
    resources: {
      "RESOURCE_WOOD": number,
      "RESOURCE_STONE": number,
      "SEED_WHEAT": number,
      "CROP_WHEAT": number
      // ... å…¶ä»–èµ„æºç±»å‹
    };
  };

  // ä¸´æ—¶å¼¹çª—é€šçŸ¥ (å‰ç«¯å±•ç¤ºåä¼šè‡ªåŠ¨æ·¡å‡ºï¼Œåç«¯åªéœ€å‘é€ä¸€æ¬¡)
  popups: {
    id: string;
    text: string;
    icon?: string;
    timestamp: number;
  }[];

  // ä¼¤å®³é£˜å­— (å‰ç«¯å±•ç¤ºåè‡ªåŠ¨æ·¡å‡º)
  floatingTexts: {
    id: string;
    x: number;
    y: number;
    text: string;
    colorClass: string; // Tailwind CSS ç±»å (å¦‚ "text-red-500")
    timestamp: number;
  }[];
}
```

### 4. å¼€å‘å»ºè®®

1.  **å¿ƒè·³/Tick**: åç«¯åº”ç»´æŠ¤ä¸€ä¸ªä¸»å¾ªç¯ï¼ˆTick Loopï¼‰ï¼Œå»ºè®®é¢‘ç‡ä¸º 20Hz (50ms)ã€‚
2.  **çŠ¶æ€åŒæ­¥**: 
    *   ä¸ºäº†ç®€åŒ–å¼€å‘ï¼ŒåˆæœŸå¯ä»¥åœ¨æ¯æ¬¡ Tick ç»“æŸæ—¶å¹¿æ’­å®Œæ•´çš„ `STATE_UPDATE` ç»™æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯ã€‚
    *   è¿›é˜¶ä¼˜åŒ–å¯æ”¹ä¸ºå‘é€ Delta (å¢é‡æ›´æ–°)ï¼Œä½†è¿™éœ€è¦ä¿®æ”¹å‰ç«¯ `RealServer.ts` çš„å¤„ç†é€»è¾‘ã€‚
3.  **å¤šç©å®¶åŒæ­¥**: 
    *   å½“ç©å®¶ A ç§»åŠ¨æ—¶ï¼Œæ›´æ–°åç«¯å†…å­˜ä¸­çš„åæ ‡ã€‚
    *   åœ¨ä¸‹ä¸€æ¬¡å¹¿æ’­æ—¶ï¼Œç©å®¶ B çš„ `entities` åˆ—è¡¨ä¸­åº”åŒ…å«ç©å®¶ A çš„æœ€æ–°åæ ‡ (ç±»å‹ä¸º `OTHER_PLAYER`)ã€‚
4.  **æŒä¹…åŒ–**: å»ºè®®å°† `player` (èƒŒåŒ…/å±æ€§) å’Œ `home` (å»ºç­‘/èµ„æº) æ•°æ®æŒä¹…åŒ–åˆ°æ•°æ®åº“ã€‚

---

## ğŸ¨ å‰ç«¯è¿è¡ŒæŒ‡å—

1.  **å®‰è£…ä¾èµ–**:
    é¡¹ç›®ä½¿ç”¨ ES Modules å’Œ CDN å¯¼å…¥ Reactï¼Œæ— éœ€å¤æ‚çš„ npm install è¿‡ç¨‹å³å¯é¢„è§ˆï¼Œä½†åœ¨å¼€å‘ç¯å¢ƒä¸‹å»ºè®®ä½¿ç”¨æ ‡å‡†çš„ React æ„å»ºå·¥å…·ã€‚

2.  **åˆ‡æ¢æ¨¡å¼**:
    æ‰“å¼€ `src/constants.ts`ï¼š
    *   è®¾ç½® `export const USE_MOCK_SERVER = true;` ä½¿ç”¨çº¯å‰ç«¯ Mock æ¨¡å¼ã€‚
    *   è®¾ç½® `export const USE_MOCK_SERVER = false;` è¿æ¥çœŸå®åç«¯ã€‚

3.  **å¯åŠ¨**:
    ç›´æ¥æ‰“å¼€ `index.html` æˆ–ä½¿ç”¨ Live Server é¢„è§ˆã€‚
